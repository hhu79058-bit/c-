<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤–å–ç³»ç»Ÿ - å›¾ç‰‡ä¸Šä¼ æ¼”ç¤º</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #333; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="password"], input[type="number"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; }
        #preview { max-width: 200px; margin-top: 10px; display: none; border: 1px solid #ddd; padding: 5px; }
        .log { background: #333; color: #0f0; padding: 10px; border-radius: 4px; font-family: monospace; height: 150px; overflow-y: auto; margin-top: 20px; }
        .step { border-left: 4px solid #007bff; padding-left: 15px; margin-bottom: 20px; }
        .step.active { border-color: #28a745; }
    </style>
</head>
<body>
    <h1>ğŸ“¸ å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½æ¼”ç¤º</h1>

    <!-- æ­¥éª¤1ï¼šç™»å½• -->
    <div class="card step" id="step1">
        <h2>1. å•†å®¶ç™»å½•</h2>
        <div class="form-group">
            <label>ç”¨æˆ·å</label>
            <input type="text" id="username" value="merchant_test" placeholder="è¾“å…¥å•†å®¶è´¦å·">
        </div>
        <div class="form-group">
            <label>å¯†ç </label>
            <input type="password" id="password" value="123456" placeholder="è¾“å…¥å¯†ç ">
        </div>
        <button onclick="login()">ç™»å½•è·å–Token</button>
    </div>

    <!-- æ­¥éª¤2ï¼šä¸Šä¼ å›¾ç‰‡ -->
    <div class="card step" id="step2" style="opacity: 0.5; pointer-events: none;">
        <h2>2. ä¸Šä¼ èœå“å›¾ç‰‡</h2>
        <div class="form-group">
            <label>é€‰æ‹©å›¾ç‰‡</label>
            <input type="file" id="imageFile" accept="image/*">
        </div>
        <button onclick="uploadImage()">ä¸Šä¼ å›¾ç‰‡</button>
        <div id="uploadResult" style="margin-top: 10px; font-weight: bold; color: #28a745;"></div>
        <img id="preview" src="" alt="é¢„è§ˆ">
    </div>

    <!-- æ­¥éª¤3ï¼šåˆ›å»ºå•†å“ -->
    <div class="card step" id="step3" style="opacity: 0.5; pointer-events: none;">
        <h2>3. å‘å¸ƒå¸¦å›¾å•†å“</h2>
        <div class="form-group">
            <label>èœå“åç§°</label>
            <input type="text" id="productName" value="æ‹›ç‰Œçº¢çƒ§è‚‰">
        </div>
        <div class="form-group">
            <label>ä»·æ ¼</label>
            <input type="number" id="price" value="38.5">
        </div>
        <div class="form-group">
            <label>å›¾ç‰‡è·¯å¾„ (è‡ªåŠ¨å¡«å……)</label>
            <input type="text" id="imageUrl" readonly style="background: #eee;">
        </div>
        <button onclick="createProduct()">å‘å¸ƒå•†å“</button>
    </div>

    <!-- æ­¥éª¤4ï¼šå•†å“åˆ—è¡¨ -->
    <div class="card step" id="step4" style="opacity: 0.5; pointer-events: none;">
        <h2>4. æˆ‘çš„å•†å“åˆ—è¡¨</h2>
        <button onclick="loadProducts()">åˆ·æ–°åˆ—è¡¨</button>
        <div id="productList" style="margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
            <!-- å•†å“å¡ç‰‡å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
        </div>
    </div>

    <div class="log" id="logConsole">æ—¥å¿—æ§åˆ¶å°...</div>

    <script>
        const API_BASE = '/api'; // ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œè‡ªåŠ¨é€‚é…å½“å‰åŸŸå
        let token = '';

        function log(msg) {
            const console = document.getElementById('logConsole');
            console.innerHTML += `<div>> ${msg}</div>`;
            console.scrollTop = console.scrollHeight;
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                log('æ­£åœ¨ç™»å½•...');
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (!res.ok) throw new Error('ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥è´¦å·å¯†ç ');
                
                const data = await res.json();
                token = data.token;
                
                if (data.userType !== 1) {
                    throw new Error('è¯·ä½¿ç”¨å•†å®¶è´¦å·ç™»å½•ï¼');
                }

                log('ç™»å½•æˆåŠŸï¼Tokenå·²è·å–');
                activateStep('step2');
            } catch (err) {
                log(`âŒ é”™è¯¯: ${err.message}`);
                alert(err.message);
            }
        }

        async function uploadImage() {
            const fileInput = document.getElementById('imageFile');
            if (fileInput.files.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                log('æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...');
                const res = await fetch(`${API_BASE}/upload/image`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                if (!res.ok) throw new Error('ä¸Šä¼ å¤±è´¥');

                const data = await res.json();
                const url = data.url;
                
                log(`ä¸Šä¼ æˆåŠŸï¼è·¯å¾„: ${url}`);
                
                // æ˜¾ç¤ºé¢„è§ˆ
                const preview = document.getElementById('preview');
                preview.src = `https://localhost:7070${url}`; // æ³¨æ„ç«¯å£
                preview.style.display = 'block';
                
                // å¡«å……ä¸‹ä¸€æ­¥
                document.getElementById('imageUrl').value = url;
                document.getElementById('uploadResult').innerText = `å›¾ç‰‡å·²ä¸Šä¼ : ${url}`;
                activateStep('step3');
            } catch (err) {
                log(`âŒ ä¸Šä¼ é”™è¯¯: ${err.message}`);
            }
        }

        async function createProduct() {
            const product = {
                productName: document.getElementById('productName').value,
                price: parseFloat(document.getElementById('price').value),
                imageUrl: document.getElementById('imageUrl').value,
                description: "è¿™æ˜¯é€šè¿‡æ¼”ç¤ºé¡µé¢ä¸Šä¼ çš„ç¾å‘³ä½³è‚´",
                isAvailable: true
            };

            try {
                log('æ­£åœ¨åˆ›å»ºå•†å“...');
                const res = await fetch(`${API_BASE}/merchant/products`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(product)
                });

                if (!res.ok) throw new Error('åˆ›å»ºå•†å“å¤±è´¥');

                const data = await res.json();
                log(`âœ… å•†å“åˆ›å»ºæˆåŠŸï¼ID: ${data.productId}`);
                
                // æ¿€æ´»ä¸‹ä¸€æ­¥å¹¶è‡ªåŠ¨åˆ·æ–°åˆ—è¡¨
                activateStep('step4');
                loadProducts();
            } catch (err) {
                log(`âŒ åˆ›å»ºé”™è¯¯: ${err.message}`);
            }
        }

        async function loadProducts() {
            try {
                log('æ­£åœ¨åŠ è½½å•†å“åˆ—è¡¨...');
                const res = await fetch(`${API_BASE}/merchant/products`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('åŠ è½½å¤±è´¥');

                const products = await res.json();
                const listDiv = document.getElementById('productList');
                listDiv.innerHTML = ''; // æ¸…ç©ºç°æœ‰åˆ—è¡¨

                if (products.length === 0) {
                    listDiv.innerHTML = '<p>æš‚æ— å•†å“</p>';
                    return;
                }

                products.forEach(p => {
                    // å¤„ç†å›¾ç‰‡è·¯å¾„ï¼šå¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œæ‹¼æ¥åŸŸå
                    let imgSrc = p.imageUrl;
                    if (imgSrc && imgSrc.startsWith('/')) {
                        imgSrc = `https://localhost:7070${imgSrc}`;
                    }
                    // å¦‚æœæ²¡æœ‰å›¾ç‰‡ï¼Œä½¿ç”¨é»˜è®¤å ä½å›¾
                    if (!imgSrc) {
                        imgSrc = 'https://via.placeholder.com/200x150?text=No+Image';
                    }

                    const card = document.createElement('div');
                    card.style.border = '1px solid #ddd';
                    card.style.borderRadius = '8px';
                    card.style.overflow = 'hidden';
                    card.style.background = '#fff';
                    
                    card.innerHTML = `
                        <div style="height: 150px; overflow: hidden; background: #f9f9f9; display: flex; align-items: center; justify-content: center;">
                            <img src="${imgSrc}" style="width: 100%; height: 100%; object-fit: cover;" alt="${p.productName}">
                        </div>
                        <div style="padding: 10px;">
                            <h3 style="margin: 0 0 5px 0; font-size: 16px;">${p.productName}</h3>
                            <p style="margin: 0; color: #f60; font-weight: bold;">Â¥${p.price}</p>
                            <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">${p.description || 'æš‚æ— æè¿°'}</p>
                        </div>
                    `;
                    listDiv.appendChild(card);
                });
                
                log(`åˆ—è¡¨åŠ è½½å®Œæˆï¼Œå…± ${products.length} ä¸ªå•†å“`);
            } catch (err) {
                log(`âŒ åŠ è½½åˆ—è¡¨é”™è¯¯: ${err.message}`);
            }
        }

        function activateStep(stepId) {
            document.getElementById(stepId).style.opacity = '1';
            document.getElementById(stepId).style.pointerEvents = 'auto';
        }
    </script>
</body>
</html>
